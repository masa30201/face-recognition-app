# 📸 顔認識写真分類アプリ

ブラウザベースの顔認識技術を使用して、大量の写真から自動的に人物を検出・分類するWebアプリケーションです。

## ✨ 主な機能

### 完成済み機能

1. **📤 写真アップロード**
   - ドラッグ&ドロップ対応
   - 一度に最大500枚までの一括アップロード
   - 対応形式: JPEG, PNG, GIF など一般的な画像形式

2. **🤖 自動顔検出**
   - face-api.js（TensorFlow.js）を使用したブラウザ内AI処理
   - 複数の顔を同時検出
   - 顔の境界ボックスと信頼度スコアの表示

3. **👥 人物自動分類**
   - 顔特徴ベクトルによる類似度計算
   - 既存人物との自動マッチング
   - 新規人物の自動登録
   - 顔マッチング距離しきい値の調整可能

4. **🏷️ 人物管理**
   - 人物への名前付け
   - 人物ごとの写真枚数表示
   - 顔サムネイル表示
   - 人物別フィルタリング

5. **🖼️ 写真管理**
   - アップロード済み写真の一覧表示
   - 処理状態の確認（処理済み/未処理）
   - 写真詳細表示（検出された人物、顔の境界ボックス）
   - ファイル名検索機能

6. **💾 データ永続化**
   - RESTful Table APIによるデータベース保存
   - 写真情報、人物情報、顔マッチング結果の永続化
   - データのエクスポート/インポート（JSON形式）

7. **⚙️ 設定管理**
   - 顔検出信頼度しきい値の調整（0.3～0.9）
   - 顔マッチング距離しきい値の調整（0.3～0.7）
   - 全データ削除機能

8. **📊 統計情報**
   - アップロード済み写真数
   - 処理済み写真数
   - 登録人物数
   - 検出された顔の総数

## 🚀 使い方

### 0. ログイン

- アプリケーションを開くと認証画面が表示されます
- 合言葉「**mdj**」を入力してログインしてください
- 認証はセッション中のみ有効です（ブラウザを閉じるとログアウトされます）

### 1. 写真のアップロード

- **アップロードタブ**を開く
- アップロードエリアをクリック、またはファイルをドラッグ&ドロップ
- 一度に最大500枚まで選択可能
- **アップロード進捗がリアルタイムで表示されます**
- 完了すると「✓ アップロードが完了しました」と表示されます
- アップロード枚数は自動的に更新されます

### 2. 顔検出と分類

- **処理タブ**を開く
- 「AIモデル準備完了 ✓」が表示されるまで待つ
- 「🚀 顔検出を開始」ボタンをクリック
- 処理状況がリアルタイムで表示されます
- **1回の処理で最大500枚まで処理**されます
- 処理完了後、まだ未処理が残っている場合は再度ボタンをクリック
- 途中で停止したい場合は「⏸️ 一時停止」ボタンをクリック

**💡 8000枚の処理方法**:
1. 処理速度に応じて自動的に枚数調整（低速: 100枚、標準: 200枚、高速: 500枚）
2. 処理完了後「まだ○○枚の未処理写真があります」と表示されます
3. 「顔検出を開始」ボタンを再度クリックして続きを処理
4. これを繰り返して全枚数を処理します

**⚠️ API Error 500が出た場合**:
1. **設定タブ** → **処理速度** → **「低速」**に変更
2. 再度処理を実行

### 3. 人物の確認と名前付け

- **人物管理タブ**を開く
- 検出された人物が自動的にグループ化されて表示されます
- 人物カードをクリックして名前を編集

### 4. 写真の閲覧

- **写真一覧タブ**を開く
- 人物フィルターで特定の人物の写真のみ表示
- 写真をクリックして詳細表示（検出された顔の境界ボックス付き）

### 5. データのバックアップ

- **設定タブ**を開く
- 「📥 データをエクスポート」でJSON形式でダウンロード
- 別環境に移行する場合は「📤 データをインポート」で復元

## 🛠️ 技術スタック

### フロントエンド
- **HTML5/CSS3/JavaScript (ES6+)**
- **face-api.js v0.22.2** - ブラウザベースの顔検出・認識
  - SSD MobileNet V1（顔検出）
  - 68点顔ランドマーク検出
  - 顔特徴ベクトル抽出（128次元）
- **TensorFlow.js** - 機械学習モデル実行

### バックエンド/データベース
- **RESTful Table API** - データ永続化
  - テーブル: `persons`, `photos`, `face_matches`
  - CRUD操作（GET, POST, PUT, PATCH, DELETE）
  - ページネーション対応

### デプロイ
- 静的ホスティング対応（Render, Netlify, Vercel等）
- サーバーサイド処理不要（完全ブラウザベース）

## 📂 プロジェクト構造

```
├── index.html              # メインHTMLファイル
├── css/
│   └── style.css          # スタイルシート
├── js/
│   ├── app.js             # メインアプリケーションロジック
│   ├── database.js        # データベースAPIラッパー
│   ├── faceDetection.js   # 顔検出・認識機能
│   └── ui.js              # UI操作・イベントハンドラー
└── README.md              # このファイル
```

## 📊 データベーススキーマ

### テーブル1: `persons` (人物)
| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | text | 人物の一意識別子 |
| name | text | 人物名 |
| face_descriptor | text | 顔特徴ベクトル（JSON文字列） |
| thumbnail | text | サムネイル画像（Base64） |
| photo_count | number | 写真枚数 |

### テーブル2: `photos` (写真)
| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | text | 写真の一意識別子 |
| file_name | text | ファイル名 |
| file_size | number | ファイルサイズ（バイト） |
| upload_date | datetime | アップロード日時 |
| processed | bool | 処理済みフラグ |
| face_count | number | 検出された顔の数 |
| thumbnail | text | サムネイル画像（Base64） |

### テーブル3: `face_matches` (顔マッチング)
| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | text | マッチの一意識別子 |
| photo_id | text | 写真IDへの参照 |
| person_id | text | 人物IDへの参照 |
| bounding_box | text | 顔の境界ボックス（JSON文字列） |
| confidence | number | 信頼度スコア（0-1） |
| face_descriptor | text | この検出の顔特徴ベクトル |

## 🔧 カスタマイズ

### 顔検出精度の調整

**設定タブ**で以下のパラメータを調整できます：

- **検出信頼度しきい値** (0.3～0.9)
  - 低い値: より多くの顔を検出（誤検出の可能性増）
  - 高い値: 確実な顔のみ検出（見逃しの可能性増）
  - 推奨値: 0.5

- **顔マッチング距離しきい値** (0.3～0.7)
  - 低い値: より厳密なマッチング（同一人物を別人として分類する可能性増）
  - 高い値: より緩やかなマッチング（別人を同一人物として分類する可能性増）
  - 推奨値: 0.5

## ⚠️ 制限事項と注意点

1. **処理速度**: ブラウザのパフォーマンスに依存（高性能PCを推奨）
2. **バッチ処理**: 
   - 低速: 100枚/回
   - 標準: 200枚/回
   - 高速: 500枚/回
3. **大量データ対応**: 
   - 8000枚でも動作するようページネーション実装
   - データベースへの負荷を最小限に抑制
   - サーバータイムアウトを防止
4. **画像サイズ**: 大きすぎる画像は自動リサイズされます
5. **ブラウザ対応**: モダンブラウザ（Chrome, Firefox, Edge, Safari）推奨
6. **アップロード中のブロック**: アップロード中は新しいアップロードをブロック
7. **統計情報**: 処理済み枚数はサンプリングによる推定値（完全に正確ではない）
8. **プライバシー**: すべての処理はブラウザ内で完結（画像は外部送信されません）

## 🔒 セキュリティとプライバシー

### 認証機能
- ✅ 合言葉「mdj」による認証を実装
- ✅ セッションストレージによる認証状態管理
- ✅ ブラウザを閉じると自動的にログアウト
- ✅ 不正アクセスを防止してAPI使用を保護

### プライバシー
- ✅ すべての画像処理はブラウザ内で実行
- ✅ 画像データは外部サーバーに送信されません
- ✅ データベースはプロジェクト専用の環境に保存
- ✅ オフライン動作も可能（モデル読み込み後）

## 📝 今後の拡張可能性

### 未実装機能（将来的に追加可能）

1. **人物マージ機能** - 誤って分割された同一人物を統合
2. **顔の手動選択** - 検出漏れの顔を手動で追加
3. **一括ダウンロード** - 人物ごとに写真をZIPでダウンロード
4. **タグ機能** - 写真にカスタムタグを追加
5. **日付フィルター** - アップロード日時でフィルタリング
6. **顔の編集** - 誤マッチングの修正機能
7. **詳細統計** - グラフやチャートでの可視化
8. **複数プロジェクト管理** - プロジェクトの切り替え

## 🚀 デプロイ方法

このアプリケーションは静的Webサイトとしてデプロイ可能です：

### Renderへのデプロイ

1. GitHubリポジトリを作成してコードをプッシュ
2. Renderで新しいStatic Siteを作成
3. GitHubリポジトリを接続
4. ビルドコマンド: なし
5. パブリッシュディレクトリ: `.` (ルート)
6. デプロイ完了後、URLにアクセス

### その他のホスティングサービス

- **Netlify**: ドラッグ&ドロップでデプロイ
- **Vercel**: GitHubと連携して自動デプロイ
- **GitHub Pages**: 無料でホスティング可能

## 📞 サポート

問題が発生した場合：

1. ブラウザのコンソールログを確認
2. 設定タブで全データを削除して再試行
3. ブラウザのキャッシュをクリア
4. モダンブラウザの最新版を使用

## 📄 ライセンス

このプロジェクトはMITライセンスのもとで公開されています。

## 🙏 謝辞

- [face-api.js](https://github.com/justadudewhohacks/face-api.js) - Vincent Mühler
- [TensorFlow.js](https://www.tensorflow.org/js) - Google

---

**バージョン**: 1.0.0  
**最終更新**: 2025年12月7日
